# Cashflow App MVP Technical Specification

## 1) Scope and source of truth
This SPEC implements the product requirements in `docs/PRD.md`.

## 2) Domain model (MVP)

### 2.1 Account
- `id`
- `name`
- `type`: `checking | savings | credit_card`
- `currentBalance`
- `lowBalanceThreshold` (optional override; else global default)

### 2.2 Transaction (canonical)
- `id`
- `userId` (MVP is single-user, but include in identity design for future multi-user)
- `accountId`
- `date` (normalized date)
- `amount` (signed number)
- `description`
- `payee` (optional)
- `categoryId` (optional)
- `institution`: `boa | chase` (for imported CSV transactions)
- `source`: `csv` (for imported CSV transactions)
- `source_ref` (nullable string; use BoA credit-card `Reference Number` when available)
- `fingerprint` (required string hash)
- `recFlag` (see section 2.6)

### 2.3 PlannedTransaction
- one-time future transaction
- fields: account, date, amount, description, category override, optional note

### 2.4 RecurringRule
- `id`, `accountId`, `description`, `amount`, `categoryId?`
- recurrence cadence config (e.g., weekly/monthly) + anchor date
- active flag
- expansion window bound by forecast horizon (6 months)

### 2.5 CreditCardPaymentPlan
- `id`, `creditCardAccountId`, `fundingAccountId`
- `strategy`: `statement_balance_default | fixed_amount | amortized_promo`
- `fixedAmount?`
- `promoMonths?` (required for amortized)
- `scheduleType`: `fixed_date` (MVP), `due_date` (deferred)
- `fixedDayOfMonth?` or next explicit date

### 2.6 RecFlag semantics
Recommended enum values:
- `none` → ordinary non-recurring transaction
- `planned_once` → user-created one-time planned transaction
- `recurring_instance` → generated by recurring rule materialization
- `credit_payment_plan` → generated by credit card payment planner

## 3) Import and sync pipeline (CSV import-first)

### 3.1 Supported institutions (MVP)
- Chase CSV
- Bank of America CSV

### 3.2 Upload/on-demand sync flow
1. User uploads CSV file.
2. System parses header + preview rows.
3. User maps source columns to canonical fields:
   - required: Date, Amount, Description/Payee
   - optional: Category, AccountName
4. Validation runs on mapped preview rows (date parse + amount parse).
5. Rows normalize into canonical Transaction shape.
6. Dedupe key generation and duplicate filtering.
7. Persist imported transactions and update account projections.

### 3.3 Validation requirements
- Hard fail on unreadable CSV or missing required mapped fields.
- Row-level validation errors tracked for date/amount parse failures.
- Deterministic behavior for invalid rows (skip + capture reason or mark invalid queue).

### 3.4 Dedupe approach
- Prefer source reference key when present: treat `(user_id, account_id, institution, source, source_ref)` as unique and skip duplicates on import.
- Always compute fallback fingerprint as:
  - `fingerprint = hash(user_id + account_id + posted_date + amount + normalized_description)`
- Enforce fallback uniqueness on `(user_id, account_id, fingerprint)`.
- Whitespace/case normalization for `normalized_description` must be deterministic.
- Deduping should work within upload batch and against existing imported rows.
- Apply DB-level unique constraints for both dedupe strategies.

### 3.5 Import result stats
- Import responses must include:
  - `imported_count`
  - `skipped_duplicates_count`

## 4) Forecast engine

### 4.1 Horizon and timeline
- Forecast window: now through now + 6 months.
- Timeline combines imported baseline + planned + recurring instances + credit payment plan transactions.

### 4.2 Calculation behavior
- Compute running balance by account.
- Compute aggregate/global cashflow across selected accounts.
- Recalculate on changes to filters, planned items, recurring rules, and payment plans.

## 5) Alerts
- Negative alert: projected balance < 0.
- Low-balance alert: projected balance < threshold.
- Alerts generated per account and available in global context.

## 6) Categories

### 6.1 Seed taxonomy
- Initial seed from BoA categories.

### 6.2 User-defined hierarchy
- Category tree with parent/child relationships.
- User can create/edit categories.
- Imported category can be overridden at transaction level.

## 7) UI requirements (MVP)
- Upload page with preview + mapping + validation feedback.
- Forecast view with:
  - global cashflow,
  - account filters,
  - alert indicators.
- Planned and recurring management screens are core, not optional.
- Credit card payment planning controls with defaults + overrides.

## 8) Deferred items
- Due-date-driven credit payment scheduling.
- Always-on automated institution sync.

## 9) Traceability to tasks
Implementation tasks in `CODEx_TASKS.md` should reference this SPEC and PRD as the canonical requirement baseline.
